<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.9/vue.js"></script>
</head>

<body>
    <div id="app">{{$store.state.count}}</div>
    <script>
        class Store {
            constructor(options) {
                let state = options.state; // {count:200}
                this.getters = {};
                this.mutations = {};
                this.actions = {}
                // 什么样的属性 可以实现双向 有get 和set new vue({data:{}})
                // vuex核心就是借用了vue的实例 因为vue的实例数据变化 会刷新视图 vdom更新 整个视图都会改变
                // this._state = new Vue({
                //     data: {
                //         state
                //     }
                // });
                this._state = Vue.observable(state) //变成响应试数据
                // Vue.util.defineReactive
                if (options.getters) {
                    let getters = options.getters; // {newCount:fn}
                    forEach(getters, (getterName, getterFn) => {
                        Object.defineProperty(this.getters, getterName, {
                            get: () => {
                                // vue.computed实现
                                return getterFn(state);
                            }
                        })
                    });
                }
                let mutations = options.mutations;
                forEach(mutations, (mutationName, mutationFn) => {
                    // this.mutations.change = ()=>{ change(state)}
                    this.mutations[mutationName] = () => {
                        mutationFn.call(this, state);
                    }
                });
                let actions = options.actions;
                forEach(actions, (actionName, actionFn) => {
                    this.actions[actionName] = () => {
                        actionFn.call(this, this);
                    }
                });
                let { commit, dispatch } = this;
                this.commit = (type) => {
                    commit.call(this, type);
                }
                this.dispatch = (type) => {
                    dispatch.call(this, type);
                }
            }
            get state() { // Object.definefineProperty get
                return this._state;
            }
            commit(type) { // undefine
                this.mutations[type].forEach(fn => fn());
            }
            dispatch(type) {
                this.actions[type].forEach(fn => fn());
            }
        }
        function forEach(obj, callback) {
            Object.keys(obj).forEach(item => callback(item, obj[item]));
        }
        const install = (Vue) => {
            Vue.mixin({
                beforeCreate() {
                    // 我需要把根组件中 store实例 给每个组件都增加一个$store的属性
                    if (this.$options && this.$options.store) { //是否是根组件
                        this.$store = this.$options.store;
                    } else { // 子组件 深度优先 父－> 子 －> 孙子
                        this.$store = this.$parent && this.$parent.$store
                    }
                }
            })
        }
        const Vuex = {
            install: install,
            Store: Store
        }
        Vue.use(Vuex); // install 方法

        const store = new Vuex.Store({
            state: {
                count: 100
            },
            getters: {
                newCount(state) { // 200
                    return state.count + 100;
                }
            },
            mutations: {
                change(state) {
                    state.count += 10
                }
            },
            actions: {
                change({ commit }) {
                    setTimeout(() => {
                        commit('change');
                    }, 1000);
                }
            }
        })



        new Vue({
            el: '#app',
            store,
            mounted() {
                console.log(this.$store.state.count)
            }
        })
    </script>
</body>

</html>